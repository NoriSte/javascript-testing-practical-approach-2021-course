
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Sharing authentication state Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-insert-logo/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="styles/website.css">
        
    

        

    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="app-actions.html" />
    

<link rel="apple-touch-icon" sizes="180x180" href="https://noriste.github.io/javascript-testing-practical-approach-2021-course/assets/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://noriste.github.io/javascript-testing-practical-approach-2021-course/assets/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://noriste.github.io/javascript-testing-practical-approach-2021-course/assets/favicons/favicon-16x16.png">
<link rel="manifest" href="https://noriste.github.io/javascript-testing-practical-approach-2021-course/assets/favicons/site.webmanifest">
<link rel="mask-icon" href="https://noriste.github.io/javascript-testing-practical-approach-2021-course/assets/favicons/safari-pinned-tab.svg" color="#50ade5">
<link rel="shortcut icon" href="https://noriste.github.io/javascript-testing-practical-approach-2021-course/assets/favicons/favicon.ico">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-config" content="https://noriste.github.io/javascript-testing-practical-approach-2021-course/assets/favicons/browserconfig.xml">
<meta name="theme-color" content="#50ade5">
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-142637808-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-142637808-2', { 'anonymize_ip': true });
</script>

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    
    
        
        <li>
            <a href="https://noriste.github.io/javascript-testing-practical-approach-2021-course/" target="_blank" class="custom-link">Javascript Testing, a Practical Approach</a>
        </li>
    
    

    
    <li class="divider"></li>
    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    React Testing Course
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="course-description.html">
            
                <a href="course-description.html">
            
                    
                    Course description
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2" data-path="about-me.html">
            
                <a href="about-me.html">
            
                    
                    About me
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="2.1" >
            
                <span>
            
                    
                    Testing definitions
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="what-is-a-test.html">
            
                <a href="what-is-a-test.html">
            
                    
                    What is a test?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2" data-path="types-of-test.html">
            
                <a href="types-of-test.html">
            
                    
                    Types of Test
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.2" >
            
                <span>
            
                    
                    Testing introduction
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.2.1" data-path="why-testing.html">
            
                <a href="why-testing.html">
            
                    
                    Why Testing?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.2" data-path="testing-rules.html">
            
                <a href="testing-rules.html">
            
                    
                    Testing rules
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.3" data-path="having-fun-while-testing.html">
            
                <a href="having-fun-while-testing.html">
            
                    
                    Having fun while testing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.4" data-path="the-cost-of-testing.html">
            
                <a href="the-cost-of-testing.html">
            
                    
                    The cost of testing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="top-to-bottom.html">
            
                <a href="top-to-bottom.html">
            
                    
                    An easier journey: top to bottom
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="4.1" >
            
                <span>
            
                    
                    E2E Testing
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" data-path="headless-browser.html">
            
                <a href="headless-browser.html">
            
                    
                    Headless browser
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2" data-path="what-is-an-e2e-test.html">
            
                <a href="what-is-an-e2e-test.html">
            
                    
                    What is an E2E test
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.2" >
            
                <span>
            
                    
                    The first E2E test
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.2.1" data-path="the-realworld-project.html">
            
                <a href="the-realworld-project.html">
            
                    
                    Conduit: the Realworld project
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.2" data-path="signup-flow-challenges.html">
            
                <a href="signup-flow-challenges.html">
            
                    
                    Testing the signup flow: challenges
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.3" data-path="opening-cypress.html">
            
                <a href="opening-cypress.html">
            
                    
                    Opening Cypress
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.4" data-path="interacting-with-the-page.html">
            
                <a href="interacting-with-the-page.html">
            
                    
                    Interacting with the page
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.5" data-path="cypress-waitings-and-execution-order.html">
            
                <a href="cypress-waitings-and-execution-order.html">
            
                    
                    Cypress waitings and execution order
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.6" >
            
                <span>
            
                    
                    Main E2E test defects
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.2.6.1" data-path="e2e-test-defects-determinism.html">
            
                <a href="e2e-test-defects-determinism.html">
            
                    
                    Determinism
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.6.2" data-path="e2e-test-defects-stability.html">
            
                <a href="e2e-test-defects-stability.html">
            
                    
                    Stability
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.6.3" data-path="utility-in-case-of-failure.html">
            
                <a href="utility-in-case-of-failure.html">
            
                    
                    Utility in case of failure
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.3" >
            
                <span>
            
                    
                    Polishing the E2E test
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.3.1" >
            
                <span>
            
                    
                    DOM elements selection
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.3.1.1" data-path="dom-elements-selection.html">
            
                <a href="dom-elements-selection.html">
            
                    
                    data-testid
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3.1.2" data-path="cypress-testing-library.html">
            
                <a href="cypress-testing-library.html">
            
                    
                    @testing-library/cypress
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.3.2" data-path="app-constants.html">
            
                <a href="app-constants.html">
            
                    
                    Sharing app constants
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.4" >
            
                <span>
            
                    
                    AJAX requests
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.4.1" data-path="waiting-for-ajax-request.html">
            
                <a href="waiting-for-ajax-request.html">
            
                    
                    Waiting for an AJAX request
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4.2" data-path="payload-assertions.html">
            
                <a href="payload-assertions.html">
            
                    
                    Asserting on payloads
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.5" >
            
                <span>
            
                    
                    Custom Commands
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.5.1" data-path="signup-custom-command.html">
            
                <a href="signup-custom-command.html">
            
                    
                    Signup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5.2" data-path="custom-command-intellisense.html">
            
                <a href="custom-command-intellisense.html">
            
                    
                    Intellisense
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5.3" data-path="app-actions.html">
            
                <a href="app-actions.html">
            
                    
                    App Actions
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="4.5.4" data-path="sharing-authentication-state.html">
            
                <a href="sharing-authentication-state.html">
            
                    
                    Sharing authentication state
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.6" >
            
                <span>
            
                    
                    UI Integration Tests
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.6.1" data-path="stubbing-the-backend.html">
            
                <a href="stubbing-the-backend.html">
            
                    
                    Stubbing the Back-end
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.6.2" data-path="fixtures.html">
            
                <a href="fixtures.html">
            
                    
                    Fixtures
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.6.3" data-path="integration-custom-command.html">
            
                <a href="integration-custom-command.html">
            
                    
                    Custom command
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.6.4" data-path="front-end-testing-on-steroids.html">
            
                <a href="front-end-testing-on-steroids.html">
            
                    
                    Front-end testing on steroids
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.6.5" data-path="cypress-as-a-development-tool.html">
            
                <a href="cypress-as-a-development-tool.html">
            
                    
                    Cypress as a development tool
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.7" >
            
                <span>
            
                    
                    Other best practices
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.7.1" data-path="dedicated-scripts.html">
            
                <a href="dedicated-scripts.html">
            
                    
                    Dedicated scripts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.7.2" data-path="monitoring-tests.html">
            
                <a href="monitoring-tests.html">
            
                    
                    Monitoring tests
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.7.3" data-path="controlling-the-clock.html">
            
                <a href="controlling-the-clock.html">
            
                    
                    Controlling the clock
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.8" data-path="continuous-integration.html">
            
                <a href="continuous-integration.html">
            
                    
                    Continuous integration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.9" data-path="visual-regression-testing.html">
            
                <a href="visual-regression-testing.html">
            
                    
                    Visual Regression Testing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.10" data-path="cypress-vs-other-tools.html">
            
                <a href="cypress-vs-other-tools.html">
            
                    
                    Cypress vs other tools
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.11" data-path="why-is-e2e-testing-not-enough.html">
            
                <a href="why-is-e2e-testing-not-enough.html">
            
                    
                    Why is E2E testing not enough?
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="resources.html">
            
                <a href="resources.html">
            
                    
                    Resources
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="6.1" data-path="about-the-book.html">
            
                <a href="about-the-book.html">
            
                    
                    About this book
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Sharing authentication state</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="sharing-authentication-state"><a name="sharing-authentication-state" class="plugin-anchor" href="#sharing-authentication-state"><i class="fa fa-link" aria-hidden="true"></i></a>Sharing authentication state</h1>
<p>We know that the state must not be shared between subsequent tests because it&apos;s the reason #1 for brittle tests. But when you know the rules, you know the motivations behind them and how to bend them to your needs.</p>
<p>Citing again the <a href="testing-rules.html#shared-state">testing rules</a>: why should we not share the state between tests? Imagine this scenario:</p>
<ul>
<li><p><code>test a</code> registers a new user and does actions that need the user to be registered</p>
</li>
<li><p><code>test b</code> does actions that need the user to be registered</p>
</li>
</ul>
<p>You are going to break the <code>test b</code> test if</p>
<ul>
<li><p>you run it alone with <code>it.only()</code></p>
</li>
<li><p>you skip the <code>test a</code> with <code>it.skip()</code></p>
</li>
<li><p>you change the order</p>
</li>
<li><p>you move the <code>test b</code> to another file or vice-versa</p>
</li>
</ul>
<p>summing up: every test <strong>must be independent</strong>.</p>
<p>In the previous chapter, we improved the test performance but it&apos;s still quite slow. Every test registers a new user and it would be cool if all the tests could share the same, already registered, user... But if we only have to maintain test independence, we could write a custom command that registers a new user, store the user token and restore the token before the next step!</p>
<p>One thing at a time:</p>
<ul>
<li>the <a href="the-realworld-project.html">RealWorld</a> front-end stores the user token with a <code>jwt</code> local storage field</li>
</ul>
<p><div>
    <img src="../assets/images/sharing-authentication-state/local-storage-jwt.png" alt="Autocompletion" style="width: 100%; margin-left: auto; margin-right: auto;">
</div>
<br><br></p>
<ul>
<li><p>we could copy it after the first registration (it can be accessed in Cypress with <code>localStorage.jwt</code>)</p>
</li>
<li><p>then, we can restore it for every future test (checking that the user is still valid and authenticated for the back-end)</p>
</li>
</ul>
<p>Let&apos;s write the <code>cy.signupV3</code> custom command, starting from the <code>cy.signupV2</code> command that&apos;s the following:</p>
<p><i>File: cypress/support/signup/signup-v2.js</i></p>
<pre><code class="lang-javascript"><span class="hljs-comment">/// &lt;reference types=&quot;Cypress&quot; /&gt;</span>

<span class="hljs-keyword">import</span> { paths } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../../../realworld/frontend/src/components/App&quot;</span>;
<span class="hljs-keyword">import</span> { noArticles } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../../../realworld/frontend/src/components/ArticleList&quot;</span>;

Cypress.Commands.add(<span class="hljs-string">&quot;signupV2&quot;</span>, ({ email, username, password } = {}) =&gt; {
  <span class="hljs-keyword">const</span> random = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">100000</span>);
  <span class="hljs-keyword">const</span> user = {
    username: username || <span class="hljs-string">`Tester<span class="hljs-subst">${random}</span>`</span>,
    email: email || <span class="hljs-string">`user+<span class="hljs-subst">${random}</span>@realworld.io`</span>,
    password: password || <span class="hljs-string">&quot;mysupersecretpassword&quot;</span>
  };

  <span class="hljs-comment">// set up AJAX call interception</span>
  cy.intercept(<span class="hljs-string">&quot;POST&quot;</span>, <span class="hljs-string">&quot;**/api/users&quot;</span>).as(<span class="hljs-string">&quot;signup-request&quot;</span>);

  cy.visit(paths.register);

  cy.window()
    .its(<span class="hljs-string">&quot;appActions&quot;</span>)
    .invoke(<span class="hljs-string">&quot;signup&quot;</span>, user);

  <span class="hljs-comment">// ... and AJAX call waiting</span>
  cy.wait(<span class="hljs-string">&quot;@signup-request&quot;</span>).should(interception =&gt; {
    expect(interception.request.body).deep.equal({
      user: {
        username: user.username,
        email: user.email,
        password: user.password
      }
    });

    expect(interception.response.statusCode).to.equal(<span class="hljs-number">200</span>);

    cy.wrap(interception.response.body)
      .should(<span class="hljs-string">&quot;have.property&quot;</span>, <span class="hljs-string">&quot;user&quot;</span>)
      .and(
        user =&gt;
          expect(user)
            .to.have.property(<span class="hljs-string">&quot;token&quot;</span>)
            .and.to.be.a(<span class="hljs-string">&quot;string&quot;</span>).and.not.to.be.empty
      )
      .and(<span class="hljs-string">&quot;deep.include&quot;</span>, {
        username: user.username.toLowerCase(),
        email: user.email
      });
  });

  <span class="hljs-comment">// end of the flow</span>
  cy.findByText(noArticles).should(<span class="hljs-string">&quot;be.visible&quot;</span>);

  cy.then(() =&gt; user);
});
</code></pre>
<h3 id="cygignupv3"><a name="cygignupv3" class="plugin-anchor" href="#cygignupv3"><i class="fa fa-link" aria-hidden="true"></i></a><code>cy.gignupV3</code></h3>
<h6 id="storing-the-token"><a name="storing-the-token" class="plugin-anchor" href="#storing-the-token"><i class="fa fa-link" aria-hidden="true"></i></a>Storing the token</h6>
<pre><code class="lang-diff">/// &lt;reference types=&quot;Cypress&quot; /&gt;

import { paths } from &quot;../../../realworld/frontend/src/components/App&quot;;
import { noArticles } from &quot;../../../realworld/frontend/src/components/ArticleList&quot;;

<span class="hljs-addition">+let previousUserData = {};</span>
Cypress.Commands.add(&quot;signupV2&quot;, ({ email, username, password } = {}) =&gt; {
  // ... the command code...

  cy
<span class="hljs-addition">+ // wait until the localStorage token is saved</span>
<span class="hljs-addition">+   .wrap(localStorage)</span>
<span class="hljs-addition">+   .its(&quot;jwt&quot;)</span>
<span class="hljs-addition">+   .should(jwt =&gt; expect(jwt).to.be.a(&quot;string&quot;).and.not.to.be.empty)</span>
<span class="hljs-addition">+   .then(jwt =&gt; {</span>
<span class="hljs-addition">+     previousUserData = {</span>
<span class="hljs-addition">+       jwt,</span>
<span class="hljs-addition">+       username,</span>
<span class="hljs-addition">+       email,</span>
<span class="hljs-addition">+       password,</span>
<span class="hljs-addition">+       user</span>
<span class="hljs-addition">+     };</span>
<span class="hljs-addition">+   })</span>
    .then(() =&gt; user);
});
</code></pre>
<p>What the new code does:</p>
<ul>
<li><p>waits until the <code>localStorage.jwt</code> token is available, the front-end does not set it synchronously (or, better, you should get accustomed that nothing is synchronous with E2E tests). This waiting is made easy by the inner <a href="https://docs.cypress.io/guides/core-concepts/retry-ability.html" target="_blank">Cypress retry-ability</a> that retries the previous command (unless it could potentially change the state of the application under test like a <code>click</code> could do) until the assertions pass.
<br>
So, the <code>jwt</code> retrieval (<code>.its(&quot;jwt&quot;)</code>) is retried until the next assertion <code>.should(jwt =&gt; expect(jwt).to.be.a(&quot;string&quot;).and.not.to.be.empty)</code> passes.</p>
</li>
<li><p>once the <code>jwt</code> token is set, it stores all the user data (the token, the parameters, and the new <code>user</code> object)</p>
</li>
<li><p>&quot;returns&quot; the <code>user</code> object with <code>.then(() =&gt; user)</code>. It&apos;s an asynchronous flow so it &quot;returns&quot; the object by chaining it</p>
</li>
</ul>
<h6 id="initial-token-check"><a name="initial-token-check" class="plugin-anchor" href="#initial-token-check"><i class="fa fa-link" aria-hidden="true"></i></a>Initial token check</h6>
<pre><code class="lang-diff">/// &lt;reference types=&quot;Cypress&quot; /&gt;

import { paths } from &quot;../../../realworld/frontend/src/components/App&quot;;
import { noArticles } from &quot;../../../realworld/frontend/src/components/ArticleList&quot;;

let previousUserData = {};
<span class="hljs-deletion">-Cypress.Commands.add(&quot;signupV2&quot;, ({ email, username, password } = {}) =&gt; {</span>
<span class="hljs-addition">+Cypress.Commands.add(&quot;signupV3&quot;, ({ email, username, password, ignoreLocalStorage = false } = {}) =&gt; {</span>
<span class="hljs-addition">+   let user;</span>
    // if the user data match the previous one
<span class="hljs-addition">+   if (!ignoreLocalStorage &amp;&amp; previousUserData.jwt &amp;&amp; previousUserData.email === email) {</span>
<span class="hljs-addition">+     cy.log(&quot;signupV3: Authentication check &#x26A0;&#xFE0F;&quot;);</span>

      // set the stored token
<span class="hljs-addition">+     localStorage.setItem(&quot;jwt&quot;, previousUserData.jwt);</span>

<span class="hljs-addition">+     cy.visit(&quot;/&quot;)</span>
      // use the &quot;New Post&quot; string to detect if the user is authenticated or not
<span class="hljs-addition">+     cy.findByText(newPost)</span>
<span class="hljs-addition">+       .then($el =&gt; $el.length !== 0)</span>
<span class="hljs-addition">+       .then(userIsAuthenticated =&gt; {</span>
<span class="hljs-addition">+         if (userIsAuthenticated) {</span>
<span class="hljs-addition">+           cy.log(&quot;signupV3: Authentication check passed &#x2705;&quot;);</span>
<span class="hljs-addition">+           user = previousUserData.user;</span>
<span class="hljs-addition">+         } else {</span>
<span class="hljs-addition">+           // removed the stored token</span>
<span class="hljs-addition">+           localStorage.removeItem(&quot;jwt&quot;);</span>
<span class="hljs-addition">+         }</span>
<span class="hljs-addition">+       });</span>
<span class="hljs-addition">+   }</span>

<span class="hljs-addition">+   cy.then(() =&gt; {</span>
<span class="hljs-addition">+     if (user) {</span>
<span class="hljs-addition">+       return user;</span>
<span class="hljs-addition">+     }</span>
<span class="hljs-addition">+     cy.log(&quot;signupV3: Authentication check failed &#x274C; a new user is going to be registered&quot;);</span>


    // ... the rest of the command code...
});
</code></pre>
<p>Step by step:</p>
<ul>
<li>first of all, we need to check that the user and the &quot;previous&quot; user are the same. We could do so checking the <code>cy.signup()</code> parameters to understand what email the test wants to have registered. And we must check that a &quot;previous user&quot; exists</li>
</ul>
<pre><code class="lang-javascript"><span class="hljs-keyword">if</span> (previousUserData.jwt &amp;&amp; previousUserData.email === email) {
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<ul>
<li>the special &quot;user restore&quot; capability must be optional, with a new <code>ignoreLocalStorage</code> option</li>
</ul>
<pre><code class="lang-javascript"><span class="hljs-keyword">if</span> (
  !ignoreLocalStorage &amp;&amp;
  previousUserData.jwt &amp;&amp;
  previousUserData.email === email
) {
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<ul>
<li>the previous user&apos;s token is set</li>
</ul>
<pre><code class="lang-javascript">localStorage.setItem(<span class="hljs-string">&quot;jwt&quot;</span>, previousUserData.jwt);
</code></pre>
<ul>
<li>then, we must check that the token is still valid for the back-end application. It should not be a problem (unless the tests last for hours) but you never know, <strong>test independence and stability must not be put at risk by a missing control</strong>. Obviously, this check must be performend from the user perspective, as we read in the <a href="@testing-library/cypress.md">@testing-library/cypress</a> chapter</li>
</ul>
<pre><code class="lang-javascript">cy.visit(<span class="hljs-string">&quot;/&quot;</span>)
<span class="hljs-comment">// use the &quot;New Post&quot; string to detect if the user is authenticated or not</span>
cy.findByText(newPost)
  .then($el =&gt; $el.length !== <span class="hljs-number">0</span>)
  .then(userIsAuthenticated =&gt; {
    <span class="hljs-comment">// now you know if the user is authenticated or not</span>
  });
</code></pre>
<ul>
<li>if the user is authenticated that&apos;s ok, it he/she is not, we must restore the initial front-end state removing the <code>jwt</code> token</li>
</ul>
<pre><code class="lang-javascript">.then(userIsAuthenticated =&gt; {
  <span class="hljs-keyword">if</span> (userIsAuthenticated) {
    cy.log(<span class="hljs-string">&quot;signupV3: Authentication check passed &#x2705;&quot;</span>);
    user = previousUserData.user;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// removed the stored token</span>
    localStorage.removeItem(<span class="hljs-string">&quot;jwt&quot;</span>);
  }
</code></pre>
<ul>
<li>last but not least: the previous register flow must be skipped</li>
</ul>
<pre><code class="lang-javascript"><span class="hljs-keyword">if</span> (user) {
  <span class="hljs-keyword">return</span> user;
}
</code></pre>
<p>Take a look at the improvement in terms of test duration, we started from the original <code>cy.signupV1</code> command</p>
<p><div>
    <img src="../assets/images/app-actions/slow-tests.png" alt="Slow tests" style="width: 100%; margin-left: auto; margin-right: auto;" class="img-border">
</div>
<br><br></p>
<p>then, we improved that with <a href="app-actions.html">App Actions</a></p>
<p><div>
    <img src="../assets/images/app-actions/slow-tests-improvement.png" alt="App Actions" style="width: 100%; margin-left: auto; margin-right: auto;" class="img-border">
</div>
<br><br></p>
<p>and finally, we leveraged the previously registered user</p>
<p><div>
    <img src="../assets/images/sharing-authentication-state/slow-tests-improvement-2.png" alt="Autocompletion" style="width: 100%; margin-left: auto; margin-right: auto;" class="img-border">
</div>
<br><br></p>
<p>You find the whole command code below</p>
<p><i>File: cypress/support/signup/signup-v3.js</i></p>
<pre><code class="lang-javascript"><span class="hljs-comment">/// &lt;reference types=&quot;Cypress&quot; /&gt;</span>

<span class="hljs-keyword">import</span> { paths } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../../../realworld/frontend/src/components/App&quot;</span>;
<span class="hljs-keyword">import</span> { noArticles } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../../../realworld/frontend/src/components/ArticleList&quot;</span>;
<span class="hljs-keyword">import</span> { newPost } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../../../realworld/frontend/src/components/Header&quot;</span>;

<span class="hljs-keyword">let</span> previousUserData = {};

Cypress.Commands.add(
  <span class="hljs-string">&quot;signupV3&quot;</span>,
  ({ email, username, password, ignoreLocalStorage = <span class="hljs-literal">false</span> } = {}) =&gt; {
    <span class="hljs-keyword">let</span> user;
    <span class="hljs-comment">// if the user data match the previous one</span>
    <span class="hljs-keyword">if</span> (!ignoreLocalStorage &amp;&amp; previousUserData.jwt &amp;&amp; previousUserData.email === email) {
      cy.log(<span class="hljs-string">&quot;signupV3: Authentication check &#x26A0;&#xFE0F;&quot;</span>);

      <span class="hljs-comment">// set the stored token</span>
      localStorage.setItem(<span class="hljs-string">&quot;jwt&quot;</span>, previousUserData.jwt);

      cy.visit(<span class="hljs-string">&quot;/&quot;</span>)
      <span class="hljs-comment">// use the &quot;New Post&quot; string to detect if the user is authenticated or not</span>
      cy.findByText(newPost)
        .then($el =&gt; $el.length !== <span class="hljs-number">0</span>)
        .then(userIsAuthenticated =&gt; {
          <span class="hljs-keyword">if</span> (userIsAuthenticated) {
            cy.log(<span class="hljs-string">&quot;signupV3: Authentication check passed &#x2705;&quot;</span>);
            user = previousUserData.user;
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// removed the stored token</span>
            localStorage.removeItem(<span class="hljs-string">&quot;jwt&quot;</span>);
          }
        });
    }

    cy.then(() =&gt; {
      <span class="hljs-keyword">if</span> (user) {
        <span class="hljs-keyword">return</span> user;
      }
      cy.log(<span class="hljs-string">&quot;signupV3: Authentication check failed &#x274C; a new user is going to be registered&quot;</span>);

      <span class="hljs-keyword">const</span> random = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">100000</span>);
      user = {
        username: username || <span class="hljs-string">`Tester<span class="hljs-subst">${random}</span>`</span>,
        email: email || <span class="hljs-string">`user+<span class="hljs-subst">${random}</span>@realworld.io`</span>,
        password: password || <span class="hljs-string">&quot;mysupersecretpassword&quot;</span>
      };

      <span class="hljs-comment">// set up AJAX call interception</span>
      cy.intercept(<span class="hljs-string">&quot;POST&quot;</span>, <span class="hljs-string">&quot;**/api/users&quot;</span>).as(<span class="hljs-string">&quot;signup-request&quot;</span>);

      cy.visit(paths.register);

      cy.window()
        .its(<span class="hljs-string">&quot;appActions&quot;</span>)
        .invoke(<span class="hljs-string">&quot;signup&quot;</span>, user);

      <span class="hljs-comment">// ... and AJAX call waiting</span>
      cy.wait(<span class="hljs-string">&quot;@signup-request&quot;</span>).should(interception =&gt; {
        expect(interception.request.body).deep.equal({
          user: {
            username: user.username,
            email: user.email,
            password: user.password
          }
        });

        expect(interception.response.statusCode).to.equal(<span class="hljs-number">200</span>);

        cy.wrap(interception.response.body)
          .should(<span class="hljs-string">&quot;have.property&quot;</span>, <span class="hljs-string">&quot;user&quot;</span>)
          .and(
            user =&gt;
              expect(user)
                .to.have.property(<span class="hljs-string">&quot;token&quot;</span>)
                .and.to.be.a(<span class="hljs-string">&quot;string&quot;</span>).and.not.to.be.empty
          )
          .and(<span class="hljs-string">&quot;deep.include&quot;</span>, {
            username: user.username.toLowerCase(),
            email: user.email
          });
      });

      <span class="hljs-comment">// end of the flow</span>
      cy.findByText(noArticles).should(<span class="hljs-string">&quot;be.visible&quot;</span>);

      <span class="hljs-comment">// wait until the localStorage token is saved</span>
      cy.wrap(localStorage)
        .its(<span class="hljs-string">&quot;jwt&quot;</span>)
        .should(jwt =&gt; expect(jwt).to.be.a(<span class="hljs-string">&quot;string&quot;</span>).and.not.to.be.empty)
        .then(jwt =&gt; {
          previousUserData = {
            jwt,
            username,
            email,
            password,
            user
          };
        })
        .then(() =&gt; user);
    });
  }
);
</code></pre>
<p>Remember that you can implement shared utilities or the above flow the way you want, but always keep in mind that you must care as much as you can about test independency and test stability. Both of them are really important for a good testing experience, one that does not make you hate the test suite.</p>
<p>With the new <code>cy.signupV3</code> custom command we are sure that:</p>
<ul>
<li><p>the first user is registered as usual</p>
</li>
<li><p>if it&apos;s possible, the test takes advantage of the previously registered user, saving precious seconds</p>
</li>
<li><p>if something goes wrong and the back-end does not recognize the previous user, a new one is registered</p>
</li>
</ul>
<p>In the end: every test that leverages the <code>cy.signupV3</code> command gets a registered user, the fastest possible way.</p>
<p>Please note: the performance improvements vary for every application, we artificially slowed down the <a href="the-realworld-project.html">RealWorld</a> for the sake of this course.</p>
<p style="text-align: right;">Author: <a href="about-us.md#stefano-magni">Stefano Magni</a></p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="app-actions.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: App Actions">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Sharing authentication state","level":"4.5.4","depth":2,"next":{"title":"UI Integration Tests","level":"4.6","depth":1,"ref":"","articles":[{"title":"Stubbing the Back-end","level":"4.6.1","depth":2,"path":"book/stubbing-the-backend.md","ref":"book/stubbing-the-backend.md","articles":[]},{"title":"Fixtures","level":"4.6.2","depth":2,"path":"book/fixtures.md","ref":"book/fixtures.md","articles":[]},{"title":"Custom command","level":"4.6.3","depth":2,"path":"book/integration-custom-command.md","ref":"book/integration-custom-command.md","articles":[]},{"title":"Front-end testing on steroids","level":"4.6.4","depth":2,"path":"book/front-end-testing-on-steroids.md","ref":"book/front-end-testing-on-steroids.md","articles":[]},{"title":"Cypress as a development tool","level":"4.6.5","depth":2,"path":"book/cypress-as-a-development-tool.md","ref":"book/cypress-as-a-development-tool.md","articles":[]}]},"previous":{"title":"App Actions","level":"4.5.3","depth":2,"path":"book/app-actions.md","ref":"book/app-actions.md","articles":[]},"dir":"ltr"},"config":{"plugins":["include-codeblock","-sharing","include","copy-code-button","github","sitemap","anchors","head-append","insert-logo","edit-link"],"styles":{"website":"book/styles/website.css"},"pluginsConfig":{"github":{"url":"https://github.com/NoriSte/javascript-testing-practical-approach-2021-course"},"head-append":{"code":["<link rel=\"apple-touch-icon\" sizes=\"180x180\" href=\"https://noriste.github.io/javascript-testing-practical-approach-2021-course/assets/favicons/apple-touch-icon.png\">","<link rel=\"icon\" type=\"image/png\" sizes=\"32x32\" href=\"https://noriste.github.io/javascript-testing-practical-approach-2021-course/assets/favicons/favicon-32x32.png\">","<link rel=\"icon\" type=\"image/png\" sizes=\"16x16\" href=\"https://noriste.github.io/javascript-testing-practical-approach-2021-course/assets/favicons/favicon-16x16.png\">","<link rel=\"manifest\" href=\"https://noriste.github.io/javascript-testing-practical-approach-2021-course/assets/favicons/site.webmanifest\">","<link rel=\"mask-icon\" href=\"https://noriste.github.io/javascript-testing-practical-approach-2021-course/assets/favicons/safari-pinned-tab.svg\" color=\"#50ade5\">","<link rel=\"shortcut icon\" href=\"https://noriste.github.io/javascript-testing-practical-approach-2021-course/assets/favicons/favicon.ico\">","<meta name=\"msapplication-TileColor\" content=\"#ffffff\">","<meta name=\"msapplication-config\" content=\"https://noriste.github.io/javascript-testing-practical-approach-2021-course/assets/favicons/browserconfig.xml\">","<meta name=\"theme-color\" content=\"#50ade5\">","<!-- Global site tag (gtag.js) - Google Analytics -->","<SCRIPTTAG async src=\"https://www.googletagmanager.com/gtag/js?id=UA-142637808-2\"></SCRIPTTAG>","<SCRIPTTAG>","  window.dataLayer = window.dataLayer || [];","  function gtag(){dataLayer.push(arguments);}","  gtag('js', new Date());","","  gtag('config', 'UA-142637808-2', { 'anonymize_ip': true });","</SCRIPTTAG>"]},"include":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"sitemap":{"hostname":"https://noriste.github.io/javascript-testing-practical-approach-2021-course/"},"copy-code-button":{},"include-codeblock":{"check":false,"edit":false,"lang":"","fixlang":false,"template":"default","theme":"chrome","unindent":false},"edit-link":{"label":"","base":"https://github.com/NoriSte/javascript-testing-practical-approach-2021-course/edit/master"},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"anchors":{},"insert-logo":{"url":"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDI1LjIuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPgo8c3ZnIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeD0iMHB4IiB5PSIwcHgiCgkgdmlld0JveD0iMCAwIDIyOTAgMTEwMCIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgMjI5MCAxMTAwOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+CjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+Cgkuc3Qwe2ZpbGw6I0Y2REYxOTt9Cgkuc3Qxe2ZpbGw6IzAxMDEwMTt9Cgkuc3Qye2ZpbGw6bm9uZTt9Cgkuc3Qze2ZvbnQtZmFtaWx5OidOZXV0cmFUZXh0LUJvbGQnO30KCS5zdDR7Zm9udC1zaXplOjEzMi45NjdweDt9Cjwvc3R5bGU+CjxnIGlkPSJndWlkZXMiPgo8L2c+CjxnIGlkPSJndWlkZXNfY29weSI+Cgk8Zz4KCQk8cmVjdCB4PSIxMTkwIiBjbGFzcz0ic3QwIiB3aWR0aD0iMTEwMCIgaGVpZ2h0PSIxMTAwIi8+CgkJPHBhdGggY2xhc3M9InN0MSIgZD0iTTE5MjguOTIsODU5LjM4YzIyLjE2LDM2LjE4LDUwLjk4LDYyLjc3LDEwMS45Nyw2Mi43N2M0Mi44MywwLDcwLjE5LTIxLjQxLDcwLjE5LTUwLjk4CgkJCWMwLTM1LjQ0LTI4LjExLTQ4LTc1LjI1LTY4LjYybC0yNS44NC0xMS4wOWMtNzQuNTktMzEuNzgtMTI0LjE0LTcxLjU5LTEyNC4xNC0xNTUuNzVjMC03Ny41Miw1OS4wNy0xMzYuNTQsMTUxLjM4LTEzNi41NAoJCQljNjUuNzIsMCwxMTIuOTcsMjIuODcsMTQ3LjAyLDgyLjc2bC04MC40OSw1MS42OGMtMTcuNzItMzEuNzgtMzYuODQtNDQuMy02Ni41Mi00NC4zYy0zMC4yOCwwLTQ5LjQ3LDE5LjIxLTQ5LjQ3LDQ0LjMKCQkJYzAsMzEuMDEsMTkuMjEsNDMuNTYsNjMuNTYsNjIuNzdsMjUuODQsMTEuMDdjODcuODMsMzcuNjYsMTM3LjQxLDc2LjA2LDEzNy40MSwxNjIuMzhjMCw5My4wNi03My4xMSwxNDQuMDUtMTcxLjI5LDE0NC4wNQoJCQljLTk2LDAtMTU4LjAyLTQ1Ljc1LTE4OC4zNi0xMDUuN0wxOTI4LjkyLDg1OS4zOHogTTE1NjMuNzcsODY4LjM0YzE2LjI0LDI4LjgxLDMxLjAxLDUzLjE3LDY2LjUyLDUzLjE3CgkJCWMzMy45NiwwLDU1LjM4LTEzLjI5LDU1LjM4LTY0Ljk1VjUwNS4wN2gxMDMuMzZ2MzUyLjg3YzAsMTA3LjAzLTYyLjc1LDE1NS43NS0xNTQuMzUsMTU1Ljc1Yy04Mi43NiwwLTEzMC42OS00Mi44My0xNTUuMDctOTQuNDIKCQkJTDE1NjMuNzcsODY4LjM0eiIvPgoJPC9nPgoJPHJlY3QgY2xhc3M9InN0MCIgd2lkdGg9IjE0MjYuMzciIGhlaWdodD0iMTEwMCIvPgoJPHJlY3QgeD0iODQuNjIiIHk9IjUwNS4wNyIgY2xhc3M9InN0MiIgd2lkdGg9IjE1NjkuNzkiIGhlaWdodD0iNTA4LjYyIi8+Cgk8dGV4dCB0cmFuc2Zvcm09Im1hdHJpeCgxIDAgMCAxIDg0LjYxNTIgNjAxLjA3NTIpIj48dHNwYW4geD0iMCIgeT0iMCIgY2xhc3M9InN0MyBzdDQiPkphdmFzY3JpcHQgVGVzdGluZzwvdHNwYW4+PHRzcGFuIHg9IjAiIHk9IjE1OS41NiIgY2xhc3M9InN0MyBzdDQiPmEgUHJhY3RpY2FsIEFwcHJvYWNoPC90c3Bhbj48L3RleHQ+CjwvZz4KPC9zdmc+Cg==","style":""}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"links":{"sidebar":{"Javascript Testing, a Practical Approach":"https://noriste.github.io/javascript-testing-practical-approach-2021-course/"},"sharing":{}},"gitbook":"*"},"file":{"path":"book/sharing-authentication-state.md","mtime":"2020-12-07T06:24:18.318Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-03-09T07:45:04.079Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-insert-logo/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-edit-link/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

